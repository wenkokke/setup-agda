name: check dist setup

on:
  workflow_call:
  workflow_dispatch:

jobs:
  check-dist-setup:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: sh
        working-directory: setup

    steps:
      - uses: actions/checkout@v3
        with: { submodules: true }

      - name: Set Node.js 16.x
        uses: actions/setup-node@v3.5.1
        with: { node-version: 16.x }

      - name: Rebuild `setup/dist/index.js`
        run: npm ci && npm run build && npm run package

      - name: Compare the expected and actual dist directories
        id: diff
        run: |
          if [ "$(git diff --ignore-space-at-eol dist/ | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build.  See status below:"
            git diff
            exit 1
          fi

      - if: ${{ failure() && steps.diff.conclusion == 'failure' && github.event_name == 'push' }}
        run: echo "UPDATE_DIST_BASE=${{ github.ref }}" >> $GITHUB_ENV

      - if: ${{ failure() && steps.diff.conclusion == 'failure' && github.event_name == 'pull_request' }}
        run: echo "UPDATE_DIST_BASE=${{ github.head_ref }}" >> $GITHUB_ENV

      # If index.js was different than expected, open a pull request:
      - uses: peter-evans/create-pull-request@v4
        if: ${{ failure() && steps.diff.conclusion == 'failure' }}
        with:
          base: ${{ env.UPDATE_DIST_BASE }}
          title: Update `setup/dist/`
          body: Automatic pull request to update `setup/dist/`
          add-paths: setup/dist/*
          branch: update-dist-setup
          branch-suffix: timestamp
          delete-branch: true
